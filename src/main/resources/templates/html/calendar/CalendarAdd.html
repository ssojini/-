<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
</head>
<script src="lib/jquery/2.2.3/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script type="text/javascript">
$(function(){
	$('#btnUpload').on('click', function(event) {
		event.preventDefault();
		    
		var form = $('#addForm')[0]
	    var data = new FormData(form);
		    
		$('#btnUpload').prop('disabled', true);
		
		console.log(data);
		for (var key of data.keys()) {
			  console.log("키"+key);
			}
			for (var value of data.values()) {
			  console.log("내용"+value);

			}
			
		$.ajax ({
			type : 'post',
		    enctype: 'multipart/form-data',
			url : '/calen/add',
		    data : data,
			dateType : 'json',
			processData: false,  
		    contentType: false,
			cache : false,
			success: function (data) {
		           $('#btnUpload').prop('disabled', false);
		           alert('저장되었습니다')
		           location.href='/calen/getCalendar'
		        },
		        error: function (e) {
		            $('#btnUpload').prop('disabled', false);
		            alert('저장실패');
			}
		});
	})	
})

$(document).ready(function (e){
	$("input[type='file']").change(function(e){
	
	$('#preview').empty();
	
	var files = e.target.files;
	var arr =Array.prototype.slice.call(files);
	      
	for(var i=0;i<files.length;i++){
		if(!checkExtension(files[i].name,files[i].size)){
	    	return false;
		}
	}     
		preview(arr);         
	});
	    
function checkExtension(fileName,fileSize){
	
	var regex = new RegExp("(.*?)\.(exe|sh|zip|alz)$");
	var maxSize = 20971520;
	      
	if(fileSize >= maxSize){
		alert('파일 사이즈 초과');
	    $("input[type='file']").val("");
	    return false;
	}
	      
	if(regex.test(fileName)){
	    alert('업로드 불가능한 파일이 있습니다.');
	    $("input[type='file']").val("");
	    return false;
	}
	    return true;
}
	    
function preview(arr){
	arr.forEach(function(f){      
		var fileName = f.name;
		if(fileName.length > 10){
			fileName = fileName.substring(0,7)+"...";
		}        
		var str = '<div style="display: inline-flex; padding: 10px;"><li style="list-style:none;">';
		str += '<span>'+fileName+'</span><br>';
		        
		if(f.type.match('image.*')){
			var reader = new FileReader(); 
		    reader.onload = function (e) {           
		    	str += '<img src="'+e.target.result+'" title="'+f.name+'" width=150 height=150 />';
		        str += '</li></div>';
		        $(str).appendTo('#preview');
		    } 
			reader.readAsDataURL(f);
		}else{
			str += '<img src="/resources/img/fileImg.png" title="'+f.name+'" width=150 height=150 />';
		    $(str).appendTo('#preview');
		 }
		});
	}
});
</script>
<body>
<div>
    <div th:replace="fragments/common :: header"></div>
</div>
<form id="addForm" action="/calen/add" method="post" enctype="multipart/form-data">
	<div>
		<input type="date" id="datetime" name="datetime" th:value="${day}">	
	</div>
	<div id="checkWhen">
		<input type="radio" name="when" id="breakfast" value="아침" checked>아침
		<input type="radio" name="when" id="lunch" value="점심">점심
		<input type="radio" name="when" id="dinner" value="저녁">저녁
		<input type="radio" name="when" id="snack" value="간식">간식
	</div>	
	<textarea id ="m_content" name="content" rows="10" cols="50" placeholder="내용을 입력하세요"></textarea>
	<div>
		<div id="preview"></div>
		<input type="file" id="pname" name="files" multiple="multiple"> 
	</div>
	<div>
		<button type="button" id="btnUpload">저장</button>
	</div>
</form>
</body>
</html>