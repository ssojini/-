<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments/common :: html-head">
<meta charset="UTF-8">
<title>장바구니</title>
</head>
<style type="text/css">
	* { 
	    margin: 0;
	    padding: 0;
	    box-sizing: border-box;
	}
		
	body {
		text-align: center;
		height:100%
		
	}
	/* .contents{ 
	display: flex
	height:auto; overflow: hidden;	
	} */
	.mymenu{
		background: #F0FFF0;
		float: left;
		width: 20%;
		height: 100vh;
		
	}
	.tb_cart{ 		
	 	float: left;		
		width: 60%;
	}
	.right_box{
		background: #696969;
		width: 20%; height: 100vh;
		float: right;
	}
	.btn_buy{
		
		top: 100px;
		position: sticky; top:0px; 
		
	}
	
	.tb_head{
	}
		

</style>
<script src="https://code.jquery.com/jquery-3.6.2.min.js" integrity="sha256-2krYZKh//PcchRtd+H+VyyQoZ/e3EcrkxhM8ycwASPA=" crossorigin="anonymous"></script>
<script type="text/javascript">
$(function(){
	var chkObj = document.getElementsByName("rowCheck");
	var rowCnt = chkObj.length;
	
	$("input[name='allCheck']").click(function(){
		var chk_listArr = $("input[name='rowCheck']");
		for (var i=0; i<chk_listArr.length; i++){
			chk_listArr[i].checked = this.checked;
		}
	});
	$("input[name='rowCheck']").click(function(){
		if($("input[name='rowCheck']:checked").length == rowCnt){
			$("input[name='allCheck']")[0].checked = true;
		}else{
			$("input[name='allCheck']")[0].checked = false;
		}
	});
	
});

function cnt_change(cartnum){
	//alert(cartnum);
	//var prod_cnt = document.getElementById(cartnum+"_cnt").value;
	var prod_cnt = $('#'+cartnum+'_cnt').val();
	//console.log(prod_cnt);
	//alert("변경수량: "+prod_cnt);	
	
	 $.ajax({
		url:'/shop/cnt_change',
		method:'post',
		cache:false,
		data: {"cartnum":cartnum,"prod_cnt":prod_cnt},
		dataType:'json',
		success: function(res){
			alert(res.msg);
			location.replace('/shop/cart');
		}, error: function(xhr,status,err){
			alert("에러: "+err);			
		}
	})	 
}

function delAll(){
	alert("전체삭제");
	$.ajax({
		url:'/shop/delAll',
		method:'post',
		cache:false,
		dataType:'json',
		success: function(res){
			alert(res.msg);			
			location.replace('/shop/cart');
		}, error: function(xhr,status,err){
			alert("에러: "+err);
		}		
	})
	
}

function delSel(){
	var valueArr = new Array();
	var list = $("input[name='rowCheck']");
	for(var i=0; i<list.length; i++){
		if(list[i].checked){
		valueArr.push(list[i].value);
		}
	}
	if(valueArr.length == 0){
		alert("선택상품이 없습니다."); 
	}else{
		var chk = confirm("정말 삭제하시겠습니까?");
		$.ajax({
			url:'/shop/delSel',
			type:'post',
			traditional: true,
			data:{valueArr:valueArr},
			//dataType:'json',
			success: function(res){
				if(res = 1){
				alert("삭제성공");
				location.replace("/shop/cart");
				}else{
				alert("삭제실패");				
				}
			}, error: function(xhr,status,err){
				alert('에러: '+err);
			}			
		});
	}
}

function buySel(){
		
	var valueArr = new Array();
	var list = $("input[name='rowCheck']");
	var loop_cnt=0;
	
	for (var i = 0; i < list.length; i++) {
		if(list[i].checked){
			//console.log(list[i]);
			var cartnum = list[i].nextElementSibling.value;
			var userid = list[i].nextElementSibling.nextElementSibling.value;
			var obj = {"cartnum":cartnum,"userid":userid};
			valueArr.push(obj);
			loop_cnt++;
		}
	}
	if(loop_cnt==0){
		alert("선택상품이 없습니다.");
		return false;
	}
	//console.log(JSON.stringify(valueArr));
	$('#items').val(JSON.stringify(valueArr));
	$('#buyCart').submit();	
	
}


	function buyAll() {
		var chk_listArr = $("input[name='rowCheck']");
		//console.log(chk_listArr);
		for (var i=0; i<chk_listArr.length; i++){
			chk_listArr[i].checked = true;
		}
		buySel();
	}
</script>
<div>
    <div th:replace="fragments/shopnav :: shopnav"></div>
</div>
<body>

	<main>
		<h3>장바구니</h3>
		<form id="buyCart" action="/shop/buycart" method="post">
		<input id="items" name="items" type="hidden"></form>
		<div style="height:20%; width:100%; background-color:#2F4F4F; color: white;">
		Head</div>	
		<div class="contents">	
		<div class="mymenu">마이메뉴</div>
		

							
		<div class="tb_cart">
			<table>
				<thead class="tb_head">
					<tr>
						<td><input id="allCheck" type="checkbox" name="allCheck"></td><td>대표이미지</td><td>상품명</td><td>주문수량</td><td>변경</td><td>주문금액</td><td>결제(개별)</td>
					</tr>
				</thead>
				<tbody>
				
					<tr th:id="${n.cartnum}" th:each="n:${cartlist}">
						<td>
							<input type="checkbox" name="rowCheck" th:value="${n.cartnum}">
							<input type="hidden" name="cartnum" th:value="${n.cartnum}">
							 <!--  login 연결후 수정 -->
							<input type="hidden" name="userid" th:value="asdf">
						</td>
						<td>[[${n.mainpic_server}]]<img alt="mainpic" th:src="'/images/goodsimg:'+${n.mainpic_server}"></td>
						<td>
							<a th:href="'/shop/detail/'+${n.goodsnum}">[[${n.goodsname}]]</a>
						</td>
						<td>
							<span th:text="${n.prod_cnt}+개"></span><br>						
							<input type="number" th:id="${n.cartnum}+'_cnt'" th:value="${n.prod_cnt}" 
							style="width: 40px; text-align: center;">
						</td>
						<td><input type="button" value="변경" th:onclick="cnt_change([[${n.cartnum}]])"></td>
						<td th:text="${n.sum}+원"></td>
						<td><a href="">주문하기</a></td>					
					</tr>	
				</tbody>
			</table>
					<div th:if="${#lists.size(cartlist)}==0">장바구니가 비었습니다.</div>
		</div>

		<div class="right_box">
				<div class="btn_buy" style="position: sticky; color: black;">
					<div>선택항목</div>
					<div style="text-align: left;">결제 금액:</div>
					<div>
						<input type="button" value="비우기(선택)" onclick="delSel()"> <input
							type="button" value="비우기(전체)" onclick="delAll()">
					</div>
					<input type="button" value="주문하기(선택)" onclick="buySel()"> <input
						type="button" value="주문하기(전체)" onclick="buyAll()">
				</div>
			</div>
		</div>


	</main>
</body>
</html>